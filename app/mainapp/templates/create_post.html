{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Post erstellen</h2>

  <form id="postForm">
    <div class="mb-3">
      <label for="group_id" class="form-label">Gruppe</label>
      <select class="form-select" id="group_id" name="group_id">
        <option value="">Keine Gruppe</option>
        {% for group in groups %}
          <option value="{{ group.id }}">{{ group.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="music_id" class="form-label">Musik</label>
      <select class="form-select" id="music_id" name="music_id" required>
        {% for music in musics %}
          <option value="{{ music.id }}">{{ music.name }} - {{ music.artist }}</option>
        {% endfor %} 
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Posten</button>
  </form>

  <div id="status" class="mt-3"></div>
</div>

<script>
document.getElementById('postForm').addEventListener('submit', async function(event) {
  event.preventDefault();

  const groupId = document.getElementById('group_id').value || null;
  const musicId = document.getElementById('music_id').value;

  const response = await fetch("{% url 'create-post' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      group_id: groupId ? parseInt(groupId) : null,
      music_id: musicId
    })
  });

  const statusDiv = document.getElementById("status");
  if (response.ok) {
    statusDiv.innerHTML = `<div class="alert alert-success">Post erfolgreich erstellt!</div>`;
    document.getElementById("postForm").reset();
  } else {
    const errorData = await response.json();
    statusDiv.innerHTML = `<div class="alert alert-danger">Fehler: ${errorData.error || 'Unbekannter Fehler'}</div>`;
  }
});
</script>
{% endblock %}