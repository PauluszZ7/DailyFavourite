{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Post erstellen</h2>
  <form id="postForm">
    <!-- Musiksuchfeld -->
    <div class="mb-3">
      <label>Musik suchen</label>
      <input type="text" id="music_search" class="form-control" placeholder="Song suchen...">
      <input type="hidden" id="music_id" name="music_id">
      <div id="search_results" class="list-group mt-2"></div>
    </div>
    <button type="submit" class="btn btn-primary">Posten</button>
  </form>
</div>

<script>
  // 1. Live Search
  document.getElementById('music_search').addEventListener('input', async (e) => {
    const query = e.target.value.trim();
    if (query.length < 2) return;

    const response = await fetch(`/api/search/spotify/?q=${query}`);
    const tracks = await response.json();
    
    const results = document.getElementById('search_results');
    results.innerHTML = tracks.map(track => `
      <a href="#" class="list-group-item" 
         onclick="document.getElementById('music_search').value='${track.name} - ${track.artist}';
                  document.getElementById('music_id').value='${track.id}';
                  this.parentNode.innerHTML=''">
        ${track.name} â€” ${track.artist}
      </a>
    `).join('');
  });

  // 2. Form submit
  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    await fetch("{% url 'create-post' %}", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        music_id: document.getElementById('music_id').value
      })
    });
    alert("Post erstellt!");
  });
</script>